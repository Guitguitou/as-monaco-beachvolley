<div class="max-w-4xl mx-auto mt-10 bg-white p-8 rounded-lg shadow-md">
  <%= form_with model: session, 
                url: session.persisted? ? session_path(session) : sessions_path, 
                method: session.persisted? ? :put : :post, 
                data: { controller: "session-form", session_form_prices_value: Session::PRICE_BY_TYPE },
                class: "space-y-12" do |f| %>

    <div class="border-b border-gray-200 pb-8">
      <h2 class="text-lg font-semibold text-gray-900">Informations de la session</h2>

      <div class="mt-8 grid grid-cols-1 gap-x-6 gap-y-6 sm:grid-cols-2">
        
        <!-- Titre -->
        <div class="sm:col-span-2">
          <%= f.label :title, "Titre", class: "block text-sm font-medium text-gray-900" %>
          <div class="mt-2">
            <%= f.text_field :title, required: true, 
                class: "block w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-gray-900 
                        placeholder:text-gray-400 focus:border-asmbv-red focus:ring-2 focus:ring-asmbv-red sm:text-sm" %>
          </div>
          <% if session.errors[:title].any? %>
            <p class="mt-1 text-sm text-red-600"><%= session.errors[:title].first %></p>
          <% end %>
        </div>

        <!-- Description -->
        <div class="sm:col-span-2">
          <%= f.label :description, "Description", class: "block text-sm font-medium text-gray-900" %>
          <div class="mt-2">
            <%= f.text_area :description, rows: 3, 
                class: "block w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-gray-900 
                        placeholder:text-gray-400 focus:border-asmbv-red focus:ring-2 focus:ring-asmbv-red sm:text-sm" %>
          </div>
          <% if session.errors[:description].any? %>
            <p class="mt-1 text-sm text-red-600"><%= session.errors[:description].first %></p>
          <% end %>
        </div>

        <!-- Type -->
        <div>
          <%= f.label :session_type, "Type de session", class: "block text-sm font-medium text-gray-900" %>
          <div class="mt-2">
            <%= f.select :session_type, 
                  options_for_select(Session.session_types.keys.map { |t| [t.humanize, t] }, session.session_type),
                  { required: true }, class: "block w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-gray-900 
                              focus:border-asmbv-red focus:ring-2 focus:ring-asmbv-red sm:text-sm",
                              data: { session_form_target: "type", action: "session-form#onTypeChange" } %>
          </div>
          <% if session.errors[:session_type].any? %>
            <p class="mt-1 text-sm text-red-600"><%= session.errors[:session_type].first %></p>
          <% end %>
        </div>

        <!-- Terrain -->
        <div>
          <%= f.label :terrain, "Terrain", class: "block text-sm font-medium text-gray-900" %>
          <div class="mt-2">
            <%= f.select :terrain, 
                  options_for_select(Session.terrains.keys, session.terrain),
                  { required: true }, class: "block w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-gray-900 
                              focus:border-asmbv-red focus:ring-2 focus:ring-asmbv-red sm:text-sm" %>
          </div>
          <% if session.errors[:terrain].any? %>
            <p class="mt-1 text-sm text-red-600"><%= session.errors[:terrain].first %></p>
          <% end %>
        </div>

        <!-- Coach / Responsable / Organisateur -->
        <div class="sm:col-span-2 hidden" data-session-form-target="userGroupCoach">
          <%= f.label :user_id, "Coach", class: "block text-sm font-medium text-gray-900" %>
          <div class="mt-2">
            <%= f.select :user_id, 
                  options_from_collection_for_select(User.coachs, :id, :full_name, session.user_id),
                  { required: true }, class: "block w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-gray-900 
                              focus:border-asmbv-red focus:ring-2 focus:ring-asmbv-red sm:text-sm" %>
          </div>
          <% if session.errors[:user_id].any? %>
            <p class="mt-1 text-sm text-red-600"><%= session.errors[:user_id].first %></p>
          <% end %>
        </div>

        <div class="sm:col-span-2 hidden" data-session-form-target="userGroupResponsable">
          <%= f.label :user_id, "Responsable", class: "block text-sm font-medium text-gray-900" %>
          <div class="mt-2">
            <%= f.select :user_id, 
                  options_from_collection_for_select(User.responsables, :id, :full_name, session.user_id),
                  { required: true }, class: "block w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-gray-900 
                              focus:border-asmbv-red focus:ring-2 focus:ring-asmbv-red sm:text-sm" %>
          </div>
          <% if session.errors[:user_id].any? %>
            <p class="mt-1 text-sm text-red-600"><%= session.errors[:user_id].first %></p>
          <% end %>
        </div>

        <div class="sm:col-span-2 hidden" data-session-form-target="userGroupAll">
          <%= f.label :user_id, "Organisateur", class: "block text-sm font-medium text-gray-900" %>
          <div class="mt-2">
            <%= f.select :user_id, 
                  options_from_collection_for_select(User.all, :id, :full_name, session.user_id),
                  { required: true }, class: "block w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-gray-900 
                              focus:border-asmbv-red focus:ring-2 focus:ring-asmbv-red sm:text-sm" %>
          </div>
          <% if session.errors[:user_id].any? %>
            <p class="mt-1 text-sm text-red-600"><%= session.errors[:user_id].first %></p>
          <% end %>
        </div>

        <!-- Dates -->
        <div>
          <%= f.label :start_at, "Date de début", class: "block text-sm font-medium text-gray-900" %>
          <div class="mt-2">
            <%= f.datetime_local_field :start_at, required: true,
                  class: "block w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-gray-900 
                          focus:border-asmbv-red focus:ring-2 focus:ring-asmbv-red sm:text-sm",
                  data: { session_form_target: "startAt", 
                  action: "change->session-form#onStartChange input->session-form#onStartChange blur->session-form#onStartChange" } %>
          </div>
          <% if session.errors[:start_at].any? %>
            <p class="mt-1 text-sm text-red-600"><%= session.errors[:start_at].first %></p>
          <% end %>
        </div>

        <div>
          <%= f.label :end_at, "Date de fin", class: "block text-sm font-medium text-gray-900" %>
          <div class="mt-2">
            <%= f.datetime_local_field :end_at, required: true,
                  class: "block w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-gray-900 
                          focus:border-asmbv-red focus:ring-2 focus:ring-asmbv-red sm:text-sm",
                  data: { session_form_target: "endAt" } %>
          </div>
          <% if session.errors[:end_at].any? %>
            <p class="mt-1 text-sm text-red-600"><%= session.errors[:end_at].first %></p>
          <% end %>
        </div>

        <!-- Max joueurs -->
        <div>
          <%= f.label :max_players, "Nombre maximum de joueurs", class: "block text-sm font-medium text-gray-900" %>
          <div class="mt-2">
            <%= f.number_field :max_players, min: 1, 
                  class: "block w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-gray-900 
                          focus:border-asmbv-red focus:ring-2 focus:ring-asmbv-red sm:text-sm" %>
          </div>
          <% if session.errors[:max_players].any? %>
            <p class="mt-1 text-sm text-red-600"><%= session.errors[:max_players].first %></p>
          <% end %>
        </div>

        <!-- Prix (crédits) -->
        <div>
          <%= f.label :price, "Prix (crédits)", class: "block text-sm font-medium text-gray-900" %>
          <div class="mt-2">
            <%= f.number_field :price, min: 0, step: 1, readonly: true,
                  class: "block w-full rounded-md border border-gray-300 bg-gray-100 px-3 py-2 text-gray-900 
                          focus:border-asmbv-red focus:ring-2 focus:ring-asmbv-red sm:text-sm",
                          data: { session_form_target: "price" } %>
          </div>
          <% if session.errors[:price].any? %>
            <p class="mt-1 text-sm text-red-600"><%= session.errors[:price].first %></p>
          <% end %>
        </div>

        <!-- Niveaux -->
        <div class="sm:col-span-2">
          <%= f.label :level_ids, "Niveaux", class: "block text-sm font-medium text-gray-900" %>
          <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-2">
            <%= f.collection_check_boxes :level_ids, Level.all, :id, :name do |b| %>
              <div class="flex items-center">
                <%= b.check_box(class: "h-4 w-4 text-asmbv-red border-gray-300 rounded focus:ring-asmbv-red") %>
                <%= b.label(class: "ml-2 text-sm text-gray-700") do %>
                  <%= "#{b.object.name} - #{b.object.gender.humanize}" %>
                <% end %>
              </div>
            <% end %>
          </div>
          <% if session.errors[:level_ids].any? %>
            <p class="mt-1 text-sm text-red-600"><%= session.errors[:level_ids].first %></p>
          <% end %>
        </div>

      </div>
    </div>

    <!-- Participants (multi-sélection avec recherche) -->
    <div class="sm:col-span-2">
      <h3 class="text-sm font-medium text-gray-900 mb-2">Participants</h3>
      <%= select_tag "session[participant_ids][]",
          options_for_select(
            User.with_enough_credits(session).map { |u| ["#{u.full_name} (#{u.balance&.amount} cr)", u.id] },
            session.participants.pluck(:id)
          ),
          multiple: true,
          class: "block w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-gray-900 focus:border-asmbv-red focus:ring-2 focus:ring-asmbv-red sm:text-sm",
          data: { controller: "select", select_placeholder_value: "Rechercher des participants..." }
      %>
      <p class="mt-1 text-xs text-gray-500">Seuls les membres avec suffisamment de crédits pour cette session sont affichés.</p>
    </div>

    <!-- Bouton -->
    <div class="flex items-center justify-end gap-x-4">
      <%= link_to "Annuler", sessions_path, class: "text-sm font-medium text-gray-500 hover:text-gray-700" %>
      <%= f.submit "Enregistrer", 
            class: "inline-flex items-center rounded-md bg-asmbv-red px-4 py-2 text-sm font-semibold text-white shadow-sm 
                    hover:bg-asmbv-red-dark focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-asmbv-red" %>
    </div>
  <% end %>
</div>
