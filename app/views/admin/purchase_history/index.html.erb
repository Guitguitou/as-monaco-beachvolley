<div class="flex items-center justify-between mb-6 flex-col gap-3 sm:flex-row sm:gap-0">
  <h1 class="text-2xl font-bold flex items-center gap-2 text-gray-900">
    <%= lucide_icon("shopping-cart") %> Historique des achats
  </h1>
  
  <%# Formulaire d'export %>
  <div class="bg-white rounded-lg border border-gray-200 shadow-sm p-4 w-full sm:w-auto">
    <%= form_with url: export_admin_purchase_history_index_path, method: :get, local: true, class: "flex flex-col sm:flex-row gap-3 items-end" do |f| %>
      <div class="flex flex-col sm:flex-row gap-3 flex-1">
        <div class="flex flex-col">
          <label for="start_date" class="text-xs font-medium text-gray-600 mb-1">Date de début</label>
          <%= f.date_field :start_date, 
              value: params[:start_date] || Date.current.beginning_of_month,
              class: "px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-asmbv-red focus:border-transparent",
              required: true %>
        </div>
        <div class="flex flex-col">
          <label for="end_date" class="text-xs font-medium text-gray-600 mb-1">Date de fin</label>
          <%= f.date_field :end_date,
              value: params[:end_date] || Date.current.end_of_month,
              class: "px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-asmbv-red focus:border-transparent",
              required: true %>
        </div>
        <%= f.hidden_field :format, value: 'csv' %>
      </div>
      <%= f.submit class: "px-4 py-2 bg-asmbv-red text-white rounded-md hover:bg-red-700 transition-colors text-sm font-medium flex items-center gap-2 whitespace-nowrap cursor-pointer",
          data: { disable_with: "Export en cours..." } do %>
        <%= lucide_icon("download", size: 16) %> Exporter CSV
      <% end %>
    <% end %>
    <p class="text-xs text-gray-500 mt-2">Par défaut, le mois en cours est sélectionné</p>
  </div>
</div>

<%# Tabs de filtrage par statut %>
<div id="status-tabs" class="flex gap-2 sm:gap-4 mb-6 border-b border-gray-200 overflow-x-auto whitespace-nowrap px-1">
  <% status_tabs = [
    { value: 'paid', label: 'Payés', icon: 'check-circle' },
    { value: 'pending', label: 'En attente', icon: 'clock' },
    { value: 'failed', label: 'Échoués/Annulés', icon: 'x-circle' }
  ] %>

  <% status_tabs.each do |tab| %>
    <% active = @status_filter == tab[:value] %>
    <%= link_to admin_purchase_history_index_path(status: tab[:value]),
        class: "px-3 sm:px-4 py-2 text-sm font-medium border-b-2 flex items-center gap-2 #{active ? 'text-asmbv-red border-asmbv-red' : 'text-gray-500 border-transparent hover:text-asmbv-red hover:border-asmbv-red'}" do %>
      <%= lucide_icon(tab[:icon], size: 16) %>
      <%= tab[:label] %>
    <% end %>
  <% end %>
  
  <%# Lien "Tous" séparé pour revenir à la vue complète %>
  <% active_all = @status_filter.blank? %>
  <%= link_to admin_purchase_history_index_path,
      class: "px-3 sm:px-4 py-2 text-sm font-medium border-b-2 flex items-center gap-2 ml-auto #{active_all ? 'text-asmbv-red border-asmbv-red' : 'text-gray-500 border-transparent hover:text-asmbv-red hover:border-asmbv-red'}" do %>
    <%= lucide_icon('list', size: 16) %>
    Tous
  <% end %>
</div>

<%# Stats Cards %>
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
  <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6">
    <div class="flex items-center gap-3">
      <div class="p-3 bg-green-100 rounded-lg">
        <%= lucide_icon("euro", size: 24, class: "text-green-600") %>
      </div>
      <div>
        <p class="text-sm font-medium text-gray-600 uppercase tracking-wide">Chiffre d'affaires</p>
        <p class="text-2xl font-bold text-gray-900"><%= number_to_currency(@total_revenue, unit: "€", precision: 2) %></p>
      </div>
    </div>
  </div>

  <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6">
    <div class="flex items-center gap-3">
      <div class="p-3 bg-blue-100 rounded-lg">
        <%= lucide_icon("shopping-bag", size: 24, class: "text-blue-600") %>
      </div>
      <div>
        <p class="text-sm font-medium text-gray-600 uppercase tracking-wide">Total achats</p>
        <p class="text-2xl font-bold text-gray-900"><%= @total_purchases %></p>
      </div>
    </div>
  </div>

  <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6">
    <div class="flex items-center gap-3">
      <div class="p-3 bg-orange-100 rounded-lg">
        <%= lucide_icon("clock", size: 24, class: "text-orange-600") %>
      </div>
      <div>
        <p class="text-sm font-medium text-gray-600 uppercase tracking-wide">En attente</p>
        <p class="text-2xl font-bold text-gray-900"><%= @pending_purchases %></p>
      </div>
    </div>
  </div>
</div>

<%# Table %>
<div class="overflow-x-auto rounded-xl border border-gray-200 shadow-sm">
  <table class="min-w-full divide-y divide-gray-200 bg-white text-sm table-fixed">
    <thead class="bg-gray-50 text-gray-600 uppercase text-xs tracking-wide">
      <tr>
        <th class="px-4 sm:px-6 py-3 text-left">Date</th>
        <th class="px-4 sm:px-6 py-3 text-left hidden lg:table-cell">Utilisateur</th>
        <th class="px-4 sm:px-6 py-3 text-left hidden md:table-cell">Pack</th>
        <th class="px-4 sm:px-6 py-3 text-left">Montant</th>
        <th class="px-4 sm:px-6 py-3 text-left hidden sm:table-cell">Crédits</th>
        <th class="px-4 sm:px-6 py-3 text-left">Statut</th>
        <th class="px-4 sm:px-6 py-3 text-left hidden xl:table-cell">Référence</th>
      </tr>
    </thead>
    <tbody class="divide-y divide-gray-100">
      <% @credit_purchases.each do |purchase| %>
        <tr class="hover:bg-gray-50 transition-colors">
          <!-- Date -->
          <td class="px-4 sm:px-6 py-4 text-gray-700">
            <%= l(purchase.created_at, format: :short) %>
          </td>

          <!-- Utilisateur -->
          <td class="px-4 sm:px-6 py-4 hidden lg:table-cell">
            <div class="flex flex-col">
              <% if purchase.user %>
                <span class="font-medium text-gray-800"><%= purchase.user.full_name %></span>
                <span class="text-xs text-gray-500"><%= purchase.user.email %></span>
              <% else %>
                <span class="text-gray-400 italic">Utilisateur anonyme</span>
              <% end %>
            </div>
          </td>

          <!-- Pack -->
          <td class="px-4 sm:px-6 py-4 hidden md:table-cell">
            <% if purchase.pack %>
              <span class="font-medium text-gray-800"><%= purchase.pack.name %></span>
            <% else %>
              <span class="text-gray-400 italic">Achat direct</span>
            <% end %>
          </td>

          <!-- Montant -->
          <td class="px-4 sm:px-6 py-4 font-semibold text-gray-900">
            <%= number_to_currency(purchase.amount_eur, unit: "€", precision: 2) %>
          </td>

          <!-- Crédits -->
          <td class="px-4 sm:px-6 py-4 text-gray-700 hidden sm:table-cell">
            <%= purchase.credits %>
          </td>

          <!-- Statut -->
          <td class="px-4 sm:px-6 py-4">
            <% case purchase.status %>
            <% when "paid" %>
              <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-green-100 text-green-800 text-xs font-semibold">
                <%= lucide_icon("check-circle", size: 14) %> Payé
              </span>
            <% when "pending" %>
              <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-yellow-100 text-yellow-800 text-xs font-semibold">
                <%= lucide_icon("clock", size: 14) %> En attente
              </span>
            <% when "failed" %>
              <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-red-100 text-red-800 text-xs font-semibold">
                <%= lucide_icon("x-circle", size: 14) %> Échoué
              </span>
            <% when "cancelled" %>
              <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-gray-100 text-gray-800 text-xs font-semibold">
                <%= lucide_icon("ban", size: 14) %> Annulé
              </span>
            <% end %>
          </td>

          <!-- Référence -->
          <td class="px-4 sm:px-6 py-4 text-xs font-mono text-gray-500 hidden xl:table-cell">
            <%= purchase.sherlock_transaction_reference %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>

<% if @credit_purchases.empty? %>
  <div class="text-center py-12 bg-white rounded-xl border border-gray-200 mt-6">
    <div class="flex flex-col items-center gap-3">
      <%= lucide_icon("shopping-cart", size: 48, class: "text-gray-300") %>
      <p class="text-gray-500 text-lg">Aucun achat pour le moment</p>
    </div>
  </div>
<% end %>
