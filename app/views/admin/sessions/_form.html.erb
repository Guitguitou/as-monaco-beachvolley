<%# Inline errors shown under fields; no global block %>

<%= form_with model: session, 
              url: session.persisted? ? admin_session_path(session) : admin_sessions_path, 
              method: session.persisted? ? :put : :post, 
              data: { controller: "session-form", session_form_prices_value: Session::PRICE_BY_TYPE },
               class: "space-y-6 bg-white p-6 rounded-lg shadow-md max-w-3xl mx-auto" do |f| %>

  <!-- Titre -->
  <div>
    <%= f.label :title, "Titre", class: "block text-sm font-medium text-gray-900" %>
    <%= f.text_field :title, required: true,
          class: "mt-1 block w-full rounded-md border border-gray-300 bg-white px-3 py-2 
                  text-gray-900 placeholder:text-gray-400 focus:border-asmbv-red focus:ring-2 
                  focus:ring-asmbv-red sm:text-sm" %>
    <% if session.errors[:title].any? %>
      <p class="mt-1 text-sm text-red-600"><%= session.errors[:title].first %></p>
    <% end %>
  </div>

  <!-- Description -->
  <div>
    <%= f.label :description, "Description", class: "block text-sm font-medium text-gray-900" %>
    <%= f.text_area :description, rows: 3,
          class: "mt-1 block w-full rounded-md border border-gray-300 bg-white px-3 py-2 
                  text-gray-900 placeholder:text-gray-400 focus:border-asmbv-red focus:ring-2 
                  focus:ring-asmbv-red sm:text-sm" %>
    <% if session.errors[:description].any? %>
      <p class="mt-1 text-sm text-red-600"><%= session.errors[:description].first %></p>
    <% end %>
  </div>

  <!-- Notes entraîneur (entrainement uniquement, privé coach/admin) -->
  <div>
    <%= f.label :coach_notes, "Notes entraîneur (privé)", class: "block text-sm font-medium text-gray-900" %>
    <%= f.text_area :coach_notes, rows: 4,
          class: "mt-1 block w-full rounded-md border border-gray-300 bg-white px-3 py-2 
                  text-gray-900 placeholder:text-gray-400 focus:border-asmbv-red focus:ring-2 
                  focus:ring-asmbv-red sm:text-sm" %>
    <p class="text-xs text-gray-500 mt-1">Visible uniquement par les coachs et les admins. Utilisez-le pour le thème, les retours, etc.</p>
  </div>

  <!-- Type de session -->
  <div>
    <%= f.label :session_type, "Type de session", class: "block text-sm font-medium text-gray-900" %>
    <%= f.select :session_type, 
          options_for_select(Session.session_types.keys.map { |t| [t.humanize, t] }, session.session_type),
          {}, class: "mt-1 block w-full rounded-md border border-gray-300 bg-white px-3 py-2
                      text-gray-900 focus:border-asmbv-red focus:ring-2 focus:ring-asmbv-red sm:text-sm",
             data: { session_form_target: "type", action: "session-form#onTypeChange" } %>
    <% if session.errors[:session_type].any? %>
      <p class="mt-1 text-sm text-red-600"><%= session.errors[:session_type].first %></p>
    <% end %>
  </div>

  <!-- Terrain -->
  <div>
    <%= f.label :terrain, "Terrain", class: "block text-sm font-medium text-gray-900" %>
    <%= f.select :terrain,
          options_for_select(Session.terrains.keys.map { |t| ["Terrain #{t.to_s.split('_').last}", t] }, session.terrain),
          {}, class: "mt-1 block w-full rounded-md border border-gray-300 bg-white px-3 py-2
                      text-gray-900 focus:border-asmbv-red focus:ring-2 focus:ring-asmbv-red sm:text-sm" %>
    <% if session.errors[:terrain].any? %>
      <p class="mt-1 text-sm text-red-600"><%= session.errors[:terrain].first %></p>
    <% end %>
  </div>

  <!-- Option admin: créer sur les 3 terrains -->
  <div class="flex items-start gap-2">
    <%= check_box_tag 'session[create_on_all_terrains]', '1', false, id: 'session_create_on_all_terrains', class: "mt-1 h-4 w-4 text-asmbv-red border-gray-300 rounded focus:ring-asmbv-red" %>
    <div>
      <label for="session_create_on_all_terrains" class="text-sm font-medium text-gray-900">Créer la même session sur les 3 terrains</label>
      <p class="text-xs text-gray-500">Cree 3 sessions identiques, une par terrain (1, 2 et 3).</p>
    </div>
  </div>

  <!-- Coach / Responsable / Organisateur -->
  <div class="hidden" data-session-form-target="userGroupCoach">
    <%= f.label :user_id, "Coach", class: "block text-sm font-medium text-gray-900" %>
    <%= f.select :user_id, options_from_collection_for_select(User.coachs, :id, :full_name, session.user_id),
          {}, class: "mt-1 block w-full rounded-md border border-gray-300 bg-white px-3 py-2
                      text-gray-900 focus:border-asmbv-red focus:ring-2 focus:ring-asmbv-red sm:text-sm" %>
    <% if session.errors[:user_id].any? %>
      <p class="mt-1 text-sm text-red-600"><%= session.errors[:user_id].first %></p>
    <% end %>
  </div>

  <div class="hidden" data-session-form-target="userGroupResponsable">
    <%= f.label :user_id, "Responsable", class: "block text-sm font-medium text-gray-900" %>
    <%= f.select :user_id, options_from_collection_for_select(User.responsables, :id, :full_name, session.user_id),
          {}, class: "mt-1 block w-full rounded-md border border-gray-300 bg-white px-3 py-2
                      text-gray-900 focus:border-asmbv-red focus:ring-2 focus:ring-asmbv-red sm:text-sm" %>
  </div>

  <div class="hidden" data-session-form-target="userGroupAll">
    <%= f.label :user_id, "Organisateur", class: "block text-sm font-medium text-gray-900" %>
    <%= f.select :user_id, options_from_collection_for_select(User.all, :id, :full_name, session.user_id),
          {}, class: "mt-1 block w-full rounded-md border border-gray-300 bg-white px-3 py-2
                      text-gray-900 focus:border-asmbv-red focus:ring-2 focus:ring-asmbv-red sm:text-sm" %>
  </div>

  <!-- Dates -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div>
      <%= f.label :start_at, "Début", class: "block text-sm font-medium text-gray-900" %>
      <%= f.datetime_local_field :start_at,
            class: "mt-1 block w-full rounded-md border border-gray-300 bg-white px-3 py-2
                    text-gray-900 focus:border-asmbv-red focus:ring-2 focus:ring-asmbv-red sm:text-sm",
            step: 900,
            data: { session_form_target: "startAt", action: "change->session-form#onStartChange input->session-form#onStartChange blur->session-form#onStartChange" } %>
    </div>

    <div>
      <%= f.label :end_at, "Fin", class: "block text-sm font-medium text-gray-900" %>
      <%= f.datetime_local_field :end_at,
            class: "mt-1 block w-full rounded-md border border-gray-300 bg-white px-3 py-2
                    text-gray-900 focus:border-asmbv-red focus:ring-2 focus:ring-asmbv-red sm:text-sm",
            step: 900,
            data: { session_form_target: "endAt", action: "input->session-form#onEndChange change->session-form#onEndChange" } %>
      <%= hidden_field_tag "session[end_at]", session.end_at&.strftime('%Y-%m-%dT%H:%M'), data: { session_form_target: "endAtHidden" } %>
    </div>
  </div>

  <!-- Ouverture des inscriptions (entraîne­ment uniquement) -->
  <div>
    <%# Affiché seulement si type = entrainement %>
    <div class="mt-4" data-session-form-target="registrationOpensWrapper" <%= session.session_type == 'entrainement' ? '' : 'style="display:none"' %>>
      <%= f.label :registration_opens_at, "Ouverture des inscriptions", class: "block text-sm font-medium text-gray-900" %>
      <%= f.datetime_local_field :registration_opens_at,
            class: "mt-1 block w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-gray-900 focus:border-asmbv-red focus:ring-2 focus:ring-asmbv-red sm:text-sm",
            step: 900 %>
      <p class="text-xs text-gray-500 mt-1">Par défaut: 7 jours avant le début. Priorité compétition pendant 24h après l’ouverture.</p>
    <% if session.errors[:registration_opens_at].any? %>
      <p class="mt-1 text-sm text-red-600"><%= session.errors[:registration_opens_at].first %></p>
    <% end %>
    </div>
  </div>

  <!-- Deadline de désinscription (optionnel, défaut midi le jour J pour entraînements) -->
  <div>
    <%= f.label :cancellation_deadline_at, "Date limite de désinscription", class: "block text-sm font-medium text-gray-900" %>
    <%= f.datetime_local_field :cancellation_deadline_at,
          class: "mt-1 block w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-gray-900 focus:border-asmbv-red focus:ring-2 focus:ring-asmbv-red sm:text-sm" %>
    <p class="text-xs text-gray-500 mt-1">Après cette date/heure, la désinscription ne rembourse pas automatiquement.</p>
    <% if session.errors[:cancellation_deadline_at].any? %>
      <p class="mt-1 text-sm text-red-600"><%= session.errors[:cancellation_deadline_at].first %></p>
    <% end %>
  </div>

  <!-- Nombre de joueurs -->
  <div>
    <%= f.label :max_players, "Nombre maximum de joueurs", class: "block text-sm font-medium text-gray-900" %>
    <%= f.number_field :max_players,
          class: "mt-1 block w-full rounded-md border border-gray-300 bg-white px-3 py-2
                  text-gray-900 focus:border-asmbv-red focus:ring-2 focus:ring-asmbv-red sm:text-sm" %>
    <% if session.errors[:max_players].any? %>
      <p class="mt-1 text-sm text-red-600"><%= session.errors[:max_players].first %></p>
    <% end %>
  </div>

  <!-- Prix (crédits) -->
  <div>
    <%= f.label :price, "Prix (crédits)", class: "block text-sm font-medium text-gray-900" %>
    <%= f.number_field :price, min: 0, step: 1, readonly: true,
          class: "mt-1 block w-full rounded-md border border-gray-300 bg-gray-100 px-3 py-2
                  text-gray-900 focus:border-asmbv-red focus:ring-2 focus:ring-asmbv-red sm:text-sm",
          data: { session_form_target: "price" } %>
    <% if session.errors[:price].any? %>
      <p class="mt-1 text-sm text-red-600"><%= session.errors[:price].first %></p>
    <% end %>
  </div>

  <!-- Niveaux -->
  <div>
    <%= f.label :level_ids, "Niveaux", class: "block text-sm font-medium text-gray-900 mb-2" %>
    <div class="flex flex-col gap-2">
      <%= f.collection_check_boxes :level_ids, (@levels || Level.all), :id, :name do |b| %>
        <label class="flex items-center gap-2">
          <%= b.check_box(class: "h-4 w-4 text-asmbv-red border-gray-300 rounded focus:ring-asmbv-red") %>
          <span class="text-sm text-gray-700"><%= "#{b.object.name} - #{b.object.gender.humanize}" %></span>
        </label>
      <% end %>
    </div>
    <% if session.errors[:level_ids].any? %>
      <p class="mt-1 text-sm text-red-600"><%= session.errors[:level_ids].first %></p>
    <% end %>
  </div>

  <!-- Bouton -->
  <div>
    <%= f.submit class: "w-full inline-flex justify-center items-center gap-x-1.5 rounded-md bg-asmbv-red px-4 py-2 
                        text-sm font-semibold text-white shadow-sm hover:bg-asmbv-red-dark 
                        focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 
                        focus-visible:outline-asmbv-red transition-colors" do %>
      <%= lucide_icon("save", size: 16) %> Enregistrer
    <% end %>
  </div>
<% end %>
