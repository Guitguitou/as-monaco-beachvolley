<div class="flex items-center justify-between mb-6 flex-col gap-3 sm:flex-row sm:gap-0">
  <h1 class="text-2xl font-bold flex items-center gap-2 text-gray-900">
    <%= lucide_icon("users") %>
    Joueurs
  </h1>

  <%= link_to new_admin_user_path,
        class: "inline-flex items-center gap-2 rounded-md bg-asmbv-red px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-asmbv-red-dark focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-asmbv-red transition-colors" do %>
    <%= lucide_icon("plus", size: 18) %>
    Nouveau joueur
  <% end %>
</div>

<%= render 'filters' %>

<div class="overflow-x-auto rounded-xl border border-gray-200 shadow-sm">
  <table class="min-w-full divide-y divide-gray-200 bg-white text-sm table-fixed">
    <thead class="bg-gray-50 text-gray-600 uppercase text-xs tracking-wide">
      <tr>
        <th scope="col" class="px-4 sm:px-6 py-3 text-left font-medium">
          <%= sortable_link_to "Nom", :name, preserve: { q: params[:q], gender: params[:gender], license_type: params[:license_type] } %>
        </th>
        <th scope="col" class="px-4 sm:px-6 py-3 text-left font-medium hidden sm:table-cell">
          <%= sortable_link_to "Email", :email, preserve: { q: params[:q], gender: params[:gender], license_type: params[:license_type] } %>
        </th>
        <th scope="col" class="px-4 sm:px-6 py-3 text-left font-medium">Rôles</th>
        <th scope="col" class="px-4 sm:px-6 py-3 text-left font-medium">
          <%= sortable_link_to "Type de licence", :license_type, preserve: { q: params[:q], gender: params[:gender], license_type: params[:license_type] } %>
        </th>
        <th scope="col" class="px-4 sm:px-6 py-3 text-left font-medium">Groupe</th>
        <th scope="col" class="px-4 sm:px-6 py-3 text-right font-medium w-16 sm:w-24">Actions</th>
      </tr>
    </thead>
    <tbody class="divide-y divide-gray-100">
      <% @users.each do |user| %>
        <tr class="hover:bg-gray-50 transition-colors">
          <!-- Nom -->
          <td class="px-4 sm:px-6 py-4 whitespace-nowrap font-medium text-gray-800 flex items-center gap-2">
            <%= lucide_icon("user", size: 16, class: "text-gray-500") %>
            <%= "#{user.last_name} #{user.first_name}" %>
          </td>

          <!-- Email -->
          <td class="px-4 sm:px-6 py-4 text-gray-700 hidden sm:table-cell"><%= user.email %></td>

          <!-- Rôles -->
          <td class="px-4 sm:px-6 py-4 space-x-1">
            <% if user.admin? %>
              <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-yellow-100 text-yellow-800 text-xs font-semibold">
                <%= lucide_icon("shield-user", size: 14) %> Admin
              </span>
            <% end %>
            <% if user.coach? %>
              <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-green-100 text-green-800 text-xs font-semibold">
                <%= lucide_icon("dumbbell", size: 14) %> Coach
              </span>
            <% end %>
            <% if user.responsable? %>
              <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-blue-100 text-blue-800 text-xs font-semibold">
                <%= lucide_icon("key-round", size: 14) %> Responsable
              </span>
            <% end %>
          </td>

          <!-- Type de licence -->
          <td class="px-4 sm:px-6 py-4">
            <% if user.license_type.present? %>
              <% if user.license_type == 'libre' %>
                <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-asmbv-red-light text-black text-xs font-semibold">
                  <%= lucide_icon("shield-half", size: 14) %> Libre
                </span>
              <% else %>
                <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-asmbv-red-light text-asmbv-red text-xs font-semibold">
                  <%= lucide_icon("trophy", size: 14) %> Compétition
                </span>
              <% end %>
            <% else %>
              <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-gray-100 text-gray-800 text-xs font-semibold">
                <%= lucide_icon("circle-off", size: 14) %> Pas de licence
              </span>
            <% end %>
          </td>

          <!-- Groupe -->
          <td class="px-4 sm:px-6 py-4">
            <% levels = user.levels.presence || [user.level].compact %>
            <% if levels.any? %>
              <%= levels.map { |l| l.respond_to?(:display_name) ? l.display_name : l.name }.join(', ') %>
            <% else %>
              –
            <% end %>
          </td>

          <!-- Actions -->
          <td class="px-4 sm:px-6 py-4 text-right space-x-2">
            <%= link_to admin_user_path(user),
                  class: "inline-flex items-center gap-1 text-sm text-gray-600 hover:text-asmbv-red transition-colors" do %>
              <%= lucide_icon("eye", size: 16) %>
              <span class="hidden sm:inline">Voir</span>
            <% end %>

            <%= link_to edit_admin_user_path(user),
                  class: "inline-flex items-center gap-1 text-sm text-gray-600 hover:text-asmbv-red-dark transition-colors" do %>
              <%= lucide_icon("edit", size: 16) %>
              <span class="hidden sm:inline">Modifier</span>
            <% end %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>

<%# Pagination controls (numbered) %>
<% if @total_pages && @total_pages > 1 %>
  <nav class="mt-4 flex items-center justify-between text-sm text-gray-700" aria-label="Pagination">
    <div>
      <% if @current_page > 1 %>
        <%= link_to({ action: :index, page: @current_page - 1, q: params[:q], gender: params[:gender], license_type: params[:license_type], sort: params[:sort], direction: params[:direction] },
                    class: "inline-flex items-center gap-1 px-3 py-1.5 rounded-md border border-gray-300 bg-white hover:bg-gray-50") do %>
          <%= lucide_icon("chevron-left", size: 16) %>
          Précédent
        <% end %>
      <% else %>
        <span class="inline-flex items-center gap-1 px-3 py-1.5 rounded-md border border-gray-200 text-gray-400">
          <%= lucide_icon("chevron-left", size: 16) %>
          Précédent
        </span>
      <% end %>
    </div>

    <ol class="flex items-center gap-1">
      <%# Build a compact page list: first, last, and a window around current %>
      <% window = 2
         pages = [1, @total_pages]
         range_start = [@current_page - window, 1].max
         range_end = [@current_page + window, @total_pages].min
         pages += (range_start..range_end).to_a
         pages = pages.uniq.sort
      %>
      <% pages.each_with_index do |page, idx| %>
        <% if idx > 0 && page - pages[idx - 1] > 1 %>
          <li class="px-2 text-gray-400">…</li>
        <% end %>
        <% if page == @current_page %>
          <li>
            <span class="inline-flex items-center justify-center w-8 h-8 rounded-md bg-asmbv-red text-white font-semibold"><%= page %></span>
          </li>
        <% else %>
          <li>
            <%= link_to page,
                        { action: :index, page: page, q: params[:q], gender: params[:gender], license_type: params[:license_type], sort: params[:sort], direction: params[:direction] },
                        class: "inline-flex items-center justify-center w-8 h-8 rounded-md border border-gray-300 bg-white hover:bg-gray-50" %>
          </li>
        <% end %>
      <% end %>
    </ol>

    <div>
      <% if @current_page < @total_pages %>
        <%= link_to({ action: :index, page: @current_page + 1, q: params[:q], gender: params[:gender], license_type: params[:license_type], sort: params[:sort], direction: params[:direction] },
                    class: "inline-flex items-center gap-1 px-3 py-1.5 rounded-md border border-gray-300 bg-white hover:bg-gray-50") do %>
          Suivant
          <%= lucide_icon("chevron-right", size: 16) %>
        <% end %>
      <% else %>
        <span class="inline-flex items-center gap-1 px-3 py-1.5 rounded-md border border-gray-200 text-gray-400">
          Suivant
          <%= lucide_icon("chevron-right", size: 16) %>
        </span>
      <% end %>
    </div>
  </nav>
<% end %>
