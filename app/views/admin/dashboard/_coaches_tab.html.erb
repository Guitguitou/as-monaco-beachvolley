<!-- Tableau des Coachs - Semaine -->
<div class="bg-white rounded-lg shadow mb-8">
  <div class="px-6 py-4 border-b border-gray-200">
    <h3 class="text-lg font-medium text-gray-900 flex items-center">
      <span class="mr-2">üë•</span>
      Coachs - Semaine
    </h3>
  </div>
  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Entra√Æneur</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Entra√Ænements</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Salaires</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Moyenne/Session</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        <% if @coach_breakdown.any? %>
          <% @coach_breakdown.each do |coach_data| %>
            <tr>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                  <div class="flex-shrink-0 h-10 w-10">
                    <div class="h-10 w-10 rounded-full bg-gray-300 flex items-center justify-center">
                      <span class="text-sm font-medium text-gray-700">
                        <%= coach_data[:user]&.first_name&.first&.upcase %><%= coach_data[:user]&.last_name&.first&.upcase %>
                      </span>
                    </div>
                  </div>
                  <div class="ml-4">
                    <div class="text-sm font-medium text-gray-900">
                      <%= coach_data[:user]&.first_name %> <%= coach_data[:user]&.last_name %>
                    </div>
                    <div class="text-sm text-gray-500">
                      <%= coach_data[:user]&.email %>
                    </div>
                  </div>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                <%= coach_data[:week_count] || 0 %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                <%= number_to_currency(coach_data[:week_amount] || 0, unit: "", separator: ",", delimiter: "") %>‚Ç¨
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                <% if coach_data[:week_count] && coach_data[:week_count] > 0 %>
                  <%= number_to_currency((coach_data[:week_amount] || 0) / coach_data[:week_count], unit: "", separator: ",", delimiter: "") %>‚Ç¨
                <% else %>
                  -
                <% end %>
              </td>
            </tr>
          <% end %>
        <% else %>
          <tr>
            <td colspan="4" class="px-6 py-4 text-center text-gray-500">Aucun entra√Ænement cette semaine</td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<!-- Tableau des Coachs - Mois -->
<div class="bg-white rounded-lg shadow mb-8">
  <div class="px-6 py-4 border-b border-gray-200">
    <h3 class="text-lg font-medium text-gray-900 flex items-center">
      <span class="mr-2">üìÖ</span>
      Coachs - Mois
    </h3>
  </div>
  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Entra√Æneur</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Entra√Ænements</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Salaires</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Moyenne/Session</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        <% if @coach_breakdown.any? %>
          <% @coach_breakdown.each do |coach_data| %>
            <tr>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                  <div class="flex-shrink-0 h-10 w-10">
                    <div class="h-10 w-10 rounded-full bg-gray-300 flex items-center justify-center">
                      <span class="text-sm font-medium text-gray-700">
                        <%= coach_data[:user]&.first_name&.first&.upcase %><%= coach_data[:user]&.last_name&.first&.upcase %>
                      </span>
                    </div>
                  </div>
                  <div class="ml-4">
                    <div class="text-sm font-medium text-gray-900">
                      <%= coach_data[:user]&.first_name %> <%= coach_data[:user]&.last_name %>
                    </div>
                    <div class="text-sm text-gray-500">
                      <%= coach_data[:user]&.email %>
                    </div>
                  </div>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                <%= coach_data[:month_count] || 0 %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                <%= number_to_currency(coach_data[:month_amount] || 0, unit: "", separator: ",", delimiter: "") %>‚Ç¨
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                <% if coach_data[:month_count] && coach_data[:month_count] > 0 %>
                  <%= number_to_currency((coach_data[:month_amount] || 0) / coach_data[:month_count], unit: "", separator: ",", delimiter: "") %>‚Ç¨
                <% else %>
                  -
                <% end %>
              </td>
            </tr>
          <% end %>
        <% else %>
          <tr>
            <td colspan="4" class="px-6 py-4 text-center text-gray-500">Aucun entra√Ænement ce mois</td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<!-- Tableau des Coachs - Ann√©e -->
<div class="bg-white rounded-lg shadow">
  <div class="px-6 py-4 border-b border-gray-200">
    <h3 class="text-lg font-medium text-gray-900 flex items-center">
      <span class="mr-2">üìä</span>
      Coachs - Ann√©e
    </h3>
  </div>
  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Entra√Æneur</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Entra√Ænements</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Salaires</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Moyenne/Session</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        <% if @coach_breakdown.any? %>
          <% @coach_breakdown.each do |coach_data| %>
            <tr>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                  <div class="flex-shrink-0 h-10 w-10">
                    <div class="h-10 w-10 rounded-full bg-gray-300 flex items-center justify-center">
                      <span class="text-sm font-medium text-gray-700">
                        <%= coach_data[:user]&.first_name&.first&.upcase %><%= coach_data[:user]&.last_name&.first&.upcase %>
                      </span>
                    </div>
                  </div>
                  <div class="ml-4">
                    <div class="text-sm font-medium text-gray-900">
                      <%= coach_data[:user]&.first_name %> <%= coach_data[:user]&.last_name %>
                    </div>
                    <div class="text-sm text-gray-500">
                      <%= coach_data[:user]&.email %>
                    </div>
                  </div>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                <%= coach_data[:year_count] || 0 %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                <%= number_to_currency(coach_data[:year_amount] || 0, unit: "", separator: ",", delimiter: "") %>‚Ç¨
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                <% if coach_data[:year_count] && coach_data[:year_count] > 0 %>
                  <%= number_to_currency((coach_data[:year_amount] || 0) / coach_data[:year_count], unit: "", separator: ",", delimiter: "") %>‚Ç¨
                <% else %>
                  -
                <% end %>
              </td>
            </tr>
          <% end %>
        <% else %>
          <tr>
            <td colspan="4" class="px-6 py-4 text-center text-gray-500">Aucun entra√Ænement cette ann√©e</td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<!-- Statistiques Mensuelles (Ann√©e en cours) -->
<div class="mt-8 mb-8">
  <div class="bg-white rounded-lg shadow">
    <div class="px-6 py-4 border-b border-gray-200">
      <h3 class="text-xl font-semibold text-gray-900 flex items-center">
        <span class="mr-2">üìÖ</span>
        Statistiques Mensuelles - <%= Time.current.year %>
      </h3>
      <p class="text-sm text-gray-500 mt-1">R√©capitulatif des sessions et salaires par mois</p>
    </div>
    
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              P√©riode
            </th>
            <% @coaches.each do |coach| %>
              <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider" colspan="2">
                <%= coach.first_name %> <%= coach.last_name&.first %>.
              </th>
            <% end %>
            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-100" colspan="2">
              Total
            </th>
          </tr>
          <tr class="bg-gray-50 border-t border-gray-200">
            <th class="px-6 py-2 text-left text-xs font-medium text-gray-400">
            </th>
            <% @coaches.each do |coach| %>
              <th class="px-3 py-2 text-center text-xs font-medium text-gray-400">
                Sessions
              </th>
              <th class="px-3 py-2 text-center text-xs font-medium text-gray-400">
                Salaire
              </th>
            <% end %>
            <th class="px-3 py-2 text-center text-xs font-medium text-gray-400 bg-gray-100">
              Sessions
            </th>
            <th class="px-3 py-2 text-center text-xs font-medium text-gray-400 bg-gray-100">
              ‚Ç¨
            </th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <% if @monthly_stats.any? %>
            <% @monthly_stats.each do |stat| %>
              <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                  <%= stat[:period] %>
                </td>
                <% @coaches.each do |coach| %>
                  <% coach_data = stat[:by_coach][coach.id] %>
                  <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-700 text-center">
                    <%= coach_data ? coach_data[:count] : '-' %>
                  </td>
                  <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-700 text-center">
                    <% if coach_data && coach_data[:count] > 0 %>
                      <%= number_to_currency(coach_data[:amount], unit: "", separator: ",", delimiter: " ") %>‚Ç¨
                    <% else %>
                      -
                    <% end %>
                  </td>
                <% end %>
                <td class="px-3 py-4 whitespace-nowrap text-sm font-semibold text-gray-900 text-center bg-gray-50">
                  <%= stat[:total_sessions] %>
                </td>
                <td class="px-3 py-4 whitespace-nowrap text-sm font-semibold text-gray-900 text-center bg-gray-50">
                  <%= number_to_currency(stat[:total_amount], unit: "", separator: ",", delimiter: " ") %>‚Ç¨
                </td>
              </tr>
            <% end %>
            
            <!-- Total Annuel -->
            <tr class="bg-blue-50 font-semibold">
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                <strong>Total <%= Time.current.year %></strong>
              </td>
              <% @coaches.each do |coach| %>
                <% 
                  total_sessions = @monthly_stats.sum { |s| s[:by_coach][coach.id]&.dig(:count) || 0 }
                  total_amount = @monthly_stats.sum { |s| s[:by_coach][coach.id]&.dig(:amount) || 0 }
                %>
                <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900 text-center">
                  <%= total_sessions %>
                </td>
                <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900 text-center">
                  <%= number_to_currency(total_amount, unit: "", separator: ",", delimiter: " ") %>‚Ç¨
                </td>
              <% end %>
              <td class="px-3 py-4 whitespace-nowrap text-sm font-bold text-gray-900 text-center bg-gray-100">
                <%= @monthly_stats.sum { |s| s[:total_sessions] } %>
              </td>
              <td class="px-3 py-4 whitespace-nowrap text-base font-bold text-gray-900 text-center bg-gray-100">
                <%= number_to_currency(@monthly_stats.sum { |s| s[:total_amount] }, unit: "", separator: ",", delimiter: " ") %>‚Ç¨
              </td>
            </tr>
          <% else %>
            <tr>
              <td colspan="<%= 1 + (@coaches.size * 2) + 2 %>" class="px-6 py-8 text-center text-gray-500">
                Aucune session enregistr√©e pour l'ann√©e <%= Time.current.year %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Statistiques Annuelles -->
<div class="mb-8">
  <div class="bg-white rounded-lg shadow">
    <div class="px-6 py-4 border-b border-gray-200">
      <h3 class="text-xl font-semibold text-gray-900 flex items-center">
        <span class="mr-2">üìä</span>
        Statistiques Annuelles
      </h3>
      <p class="text-sm text-gray-500 mt-1">R√©capitulatif historique par ann√©e</p>
    </div>
    
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Ann√©e
            </th>
            <% @coaches.each do |coach| %>
              <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider" colspan="2">
                <%= coach.first_name %> <%= coach.last_name&.first %>.
              </th>
            <% end %>
            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-100" colspan="2">
              Total
            </th>
          </tr>
          <tr class="bg-gray-50 border-t border-gray-200">
            <th class="px-6 py-2 text-left text-xs font-medium text-gray-400">
            </th>
            <% @coaches.each do |coach| %>
              <th class="px-3 py-2 text-center text-xs font-medium text-gray-400">
                Sessions
              </th>
              <th class="px-3 py-2 text-center text-xs font-medium text-gray-400">
                Salaire
              </th>
            <% end %>
            <th class="px-3 py-2 text-center text-xs font-medium text-gray-400 bg-gray-100">
              Sessions
            </th>
            <th class="px-3 py-2 text-center text-xs font-medium text-gray-400 bg-gray-100">
              ‚Ç¨
            </th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <% if @yearly_stats.any? %>
            <% @yearly_stats.each do |stat| %>
              <tr class="hover:bg-gray-50 <%= 'bg-blue-50' if stat[:year] == Time.current.year %>">
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                  <%= stat[:period] %>
                  <% if stat[:year] == Time.current.year %>
                    <span class="ml-2 text-xs bg-blue-500 text-white px-2 py-1 rounded-full">En cours</span>
                  <% end %>
                </td>
                <% @coaches.each do |coach| %>
                  <% coach_data = stat[:by_coach][coach.id] %>
                  <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-700 text-center">
                    <%= coach_data ? coach_data[:count] : '-' %>
                  </td>
                  <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-700 text-center">
                    <% if coach_data && coach_data[:count] > 0 %>
                      <%= number_to_currency(coach_data[:amount], unit: "", separator: ",", delimiter: " ") %>‚Ç¨
                    <% else %>
                      -
                    <% end %>
                  </td>
                <% end %>
                <td class="px-3 py-4 whitespace-nowrap text-sm font-semibold text-gray-900 text-center bg-gray-50">
                  <%= stat[:total_sessions] %>
                </td>
                <td class="px-3 py-4 whitespace-nowrap text-sm font-semibold text-gray-900 text-center bg-gray-50">
                  <%= number_to_currency(stat[:total_amount], unit: "", separator: ",", delimiter: " ") %>‚Ç¨
                </td>
              </tr>
            <% end %>
            
            <!-- Total G√©n√©ral -->
            <tr class="bg-indigo-50 font-bold border-t-2 border-indigo-200">
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                <strong>TOTAL G√âN√âRAL</strong>
              </td>
              <% @coaches.each do |coach| %>
                <% 
                  total_sessions = @yearly_stats.sum { |s| s[:by_coach][coach.id]&.dig(:count) || 0 }
                  total_amount = @yearly_stats.sum { |s| s[:by_coach][coach.id]&.dig(:amount) || 0 }
                %>
                <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900 text-center">
                  <strong><%= total_sessions %></strong>
                </td>
                <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900 text-center">
                  <strong><%= number_to_currency(total_amount, unit: "", separator: ",", delimiter: " ") %>‚Ç¨</strong>
                </td>
              <% end %>
              <td class="px-3 py-4 whitespace-nowrap text-sm font-bold text-gray-900 text-center bg-indigo-100">
                <strong><%= @yearly_stats.sum { |s| s[:total_sessions] } %></strong>
              </td>
              <td class="px-3 py-4 whitespace-nowrap text-lg font-bold text-indigo-700 text-center bg-indigo-100">
                <%= number_to_currency(@yearly_stats.sum { |s| s[:total_amount] }, unit: "", separator: ",", delimiter: " ") %>‚Ç¨
              </td>
            </tr>
          <% else %>
            <tr>
              <td colspan="<%= 1 + (@coaches.size * 2) + 2 %>" class="px-6 py-8 text-center text-gray-500">
                Aucune session enregistr√©e
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- KPIs Coachs -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
  <!-- KPI : Total sessions ann√©e en cours -->
  <div class="bg-white rounded-lg shadow p-6">
    <div class="flex items-center">
      <div class="flex-shrink-0">
        <div class="w-12 h-12 bg-purple-600 rounded-md flex items-center justify-center">
          <span class="text-white text-lg font-bold">üèê</span>
        </div>
      </div>
      <div class="ml-4">
        <p class="text-sm font-medium text-gray-500">Sessions <%= Time.current.year %></p>
        <p class="text-2xl font-semibold text-gray-900">
          <%= @monthly_stats.sum { |s| s[:total_sessions] } %>
        </p>
        <p class="text-xs text-gray-500">
          Salaires: <%= number_to_currency(@monthly_stats.sum { |s| s[:total_amount] }, unit: "", separator: ",", delimiter: " ") %>‚Ç¨
        </p>
      </div>
    </div>
  </div>

  <!-- KPI : Total tous temps -->
  <div class="bg-white rounded-lg shadow p-6">
    <div class="flex items-center">
      <div class="flex-shrink-0">
        <div class="w-12 h-12 bg-green-600 rounded-md flex items-center justify-center">
          <span class="text-white text-lg font-bold">üìä</span>
        </div>
      </div>
      <div class="ml-4">
        <p class="text-sm font-medium text-gray-500">Total (tous temps)</p>
        <p class="text-2xl font-semibold text-gray-900">
          <%= @yearly_stats.sum { |s| s[:total_sessions] } %> sessions
        </p>
        <p class="text-xs text-gray-500">
          Salaires: <%= number_to_currency(@yearly_stats.sum { |s| s[:total_amount] }, unit: "", separator: ",", delimiter: " ") %>‚Ç¨
        </p>
      </div>
    </div>
  </div>

  <!-- KPI : Coach le plus actif -->
  <% 
    most_active_coach = @coaches.max_by do |coach|
      @yearly_stats.sum { |s| s[:by_coach][coach.id]&.dig(:count) || 0 }
    end
    most_active_count = @yearly_stats.sum { |s| s[:by_coach][most_active_coach&.id]&.dig(:count) || 0 }
  %>
  <div class="bg-white rounded-lg shadow p-6">
    <div class="flex items-center">
      <div class="flex-shrink-0">
        <div class="w-12 h-12 bg-orange-600 rounded-md flex items-center justify-center">
          <span class="text-white text-lg font-bold">‚≠ê</span>
        </div>
      </div>
      <div class="ml-4">
        <p class="text-sm font-medium text-gray-500">Coach le plus actif</p>
        <p class="text-xl font-semibold text-gray-900">
          <% if most_active_coach %>
            <%= most_active_coach.first_name %> <%= most_active_coach.last_name&.first %>.
          <% else %>
            -
          <% end %>
        </p>
        <p class="text-xs text-gray-500">
          <%= most_active_count %> sessions
        </p>
      </div>
    </div>
  </div>
</div>
